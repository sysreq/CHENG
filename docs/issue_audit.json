[
  {
    "id": "BUG-001",
    "title": "WebSocket receive can crash on None text and byte-length checks are incorrect",
    "area": "backend",
    "severity": "medium",
    "description": "When ws.receive() returns a dict with text=None, code calls len(text) causing TypeError. Size checks use character length rather than UTF-8 byte length, allowing oversized payloads with non-ASCII characters.",
    "file": "backend/routes/websocket.py",
    "lines": "123-159",
    "suggested_fix": "Guard text for None (or use receive_text/receive_bytes). Perform size checks using len(text.encode('utf-8')).",
    "labels": [
      "bug",
      "backend",
      "websocket",
      "robustness"
    ]
  },
  {
    "id": "BUG-002",
    "title": "Export assembly cache is not thread-safe",
    "area": "backend",
    "severity": "medium",
    "description": "Global _assembly_cache dict accessed from async endpoints without a lock; concurrent requests can race on insert/evict.",
    "file": "backend/routes/export.py",
    "lines": "40-63",
    "suggested_fix": "Protect with anyio.Lock or use a thread-safe LRU cache.",
    "labels": [
      "bug",
      "backend",
      "export",
      "concurrency"
    ]
  },
  {
    "id": "BUG-003",
    "title": "STL export does redundant assembly work",
    "area": "backend",
    "severity": "low-medium",
    "description": "_export_blocking() calls _get_or_assemble() even for STL, then _export_stl_blocking() re-assembles via _generate_sections().",
    "file": "backend/routes/export.py",
    "lines": "333-348",
    "suggested_fix": "Skip _get_or_assemble() for STL or pass assembled components into _export_stl_blocking() to avoid recomputation.",
    "labels": [
      "bug",
      "backend",
      "export",
      "performance"
    ]
  },
  {
    "id": "BUG-004",
    "title": "Export zip filename allows path traversal",
    "area": "backend",
    "severity": "high",
    "description": "design.name is used directly to build zip filename. Path separators or '..' can escape EXPORT_TMP_DIR.",
    "file": "backend/export/package.py",
    "lines": "38-57",
    "suggested_fix": "Sanitize design.name to a safe slug/basename and strip separators.",
    "labels": [
      "bug",
      "security",
      "backend",
      "export"
    ]
  },
  {
    "id": "BUG-005",
    "title": "Deterministic ZIP filenames can collide",
    "area": "backend",
    "severity": "medium",
    "description": "Final ZIP name is deterministic; if file exists, rename/move can fail on Windows or in concurrent exports.",
    "file": "backend/export/package.py",
    "lines": "46-67",
    "suggested_fix": "Use unique suffix (timestamp/UUID) or remove existing file before move.",
    "labels": [
      "bug",
      "backend",
      "export",
      "concurrency"
    ]
  },
  {
    "id": "BUG-006",
    "title": "Test joint export uses fixed filename",
    "area": "backend",
    "severity": "medium",
    "description": "Always writes cheng_test_joint.zip; concurrent requests overwrite each other.",
    "file": "backend/export/test_joint.py",
    "lines": "285-291",
    "suggested_fix": "Use a unique filename per request (UUID/timestamp).",
    "labels": [
      "bug",
      "backend",
      "export",
      "concurrency"
    ]
  },
  {
    "id": "BUG-007",
    "title": "DXF/SVG export exceptions are silently swallowed",
    "area": "backend",
    "severity": "low",
    "description": "Exceptions during DXF/SVG export are ignored without logging; failures show as missing files.",
    "file": "backend/export/package.py",
    "lines": "266-268; 335-337",
    "suggested_fix": "Log a warning with component name and exception details.",
    "labels": [
      "bug",
      "backend",
      "export",
      "observability"
    ]
  },
  {
    "id": "BUG-008",
    "title": "Temp cleanup targets wrong directory",
    "area": "backend",
    "severity": "medium",
    "description": "Cleanup uses /data/tmp while exports use CHENG_DATA_DIR/tmp (default /data/designs/tmp), leaving orphaned files.",
    "file": "backend/cleanup.py",
    "lines": "15-16",
    "suggested_fix": "Use the same EXPORT_TMP_DIR or derive from CHENG_DATA_DIR everywhere.",
    "labels": [
      "bug",
      "backend",
      "cleanup",
      "storage"
    ]
  },
  {
    "id": "BUG-009",
    "title": "Design saves are non-atomic and can corrupt JSON",
    "area": "backend",
    "severity": "low-medium",
    "description": "save_design() writes directly to target path; crashes can leave truncated files.",
    "file": "backend/storage.py",
    "lines": "46-49",
    "suggested_fix": "Write to a temp file and replace atomically.",
    "labels": [
      "bug",
      "backend",
      "storage",
      "data-integrity"
    ]
  },
  {
    "id": "BUG-010",
    "title": "Weight estimation computed multiple times per validation pass",
    "area": "backend",
    "severity": "low",
    "description": "_estimate_weight_kg() called by V09/V12/V13 separately, repeating expensive computations.",
    "file": "backend/validation.py",
    "lines": "170-179; 193-200; 317-325; 358-368",
    "suggested_fix": "Compute weight once in compute_warnings and pass to checks.",
    "labels": [
      "bug",
      "backend",
      "validation",
      "performance"
    ]
  },
  {
    "id": "BUG-011",
    "title": "Generating overlay can get stuck when disconnected",
    "area": "frontend",
    "severity": "high",
    "description": "sendAndMark sets isGenerating=true, but send() drops if WebSocket not OPEN, leaving spinner stuck.",
    "file": "frontend/src/hooks/useDesignSync.ts",
    "lines": "36-40; 60-72",
    "suggested_fix": "Only set isGenerating if send succeeds or immediately clear when disconnected.",
    "labels": [
      "bug",
      "frontend",
      "websocket",
      "ux"
    ]
  },
  {
    "id": "BUG-012",
    "title": "Generating overlay never clears on error frames",
    "area": "frontend",
    "severity": "medium",
    "description": "Error frames and parse failures only log to console; isGenerating not reset.",
    "file": "frontend/src/hooks/useWebSocket.ts",
    "lines": "123-132",
    "suggested_fix": "Clear isGenerating on error/parse failures and surface error in state.",
    "labels": [
      "bug",
      "frontend",
      "websocket",
      "ux"
    ]
  },
  {
    "id": "BUG-013",
    "title": "Store subscription does extra work per mesh update",
    "area": "frontend",
    "severity": "low-medium",
    "description": "useDesignStore.subscribe listens to whole store; every WS frame triggers callback and timer logic.",
    "file": "frontend/src/hooks/useDesignSync.ts",
    "lines": "51-93",
    "suggested_fix": "Use selector-based subscription (subscribeWithSelector) to limit updates.",
    "labels": [
      "bug",
      "frontend",
      "performance",
      "state"
    ]
  },
  {
    "id": "BUG-014",
    "title": "WebSocket reconnect off-by-one reduces retries",
    "area": "frontend",
    "severity": "medium",
    "description": "incrementAttempt occurs before limit check; with max=5 the 5th attempt never runs.",
    "file": "frontend/src/hooks/useWebSocket.ts",
    "lines": "50-62",
    "suggested_fix": "Check limit before increment or compare using > after increment.",
    "labels": [
      "bug",
      "frontend",
      "websocket",
      "reliability"
    ]
  },
  {
    "id": "BUG-015",
    "title": "State leakage on new/load design",
    "area": "frontend",
    "severity": "medium",
    "description": "newDesign/loadDesign do not reset componentPrintSettings, meshOffset, isGenerating, or selection.",
    "file": "frontend/src/store/designStore.ts",
    "lines": "344-357; 421-456",
    "suggested_fix": "Reset per-component print settings, meshOffset, isGenerating, selectedComponent/selectedSubElement.",
    "labels": [
      "bug",
      "frontend",
      "state",
      "ux"
    ]
  },
  {
    "id": "BUG-016",
    "title": "Export dialog updates state after close",
    "area": "frontend",
    "severity": "medium",
    "description": "Preview/export requests are not cancellable; responses can update state after dialog closes.",
    "file": "frontend/src/components/ExportDialog.tsx",
    "lines": "641-651; 735-759; 770-804",
    "suggested_fix": "Use AbortController and guard state updates when dialog is closed/unmounted.",
    "labels": [
      "bug",
      "frontend",
      "export",
      "ux"
    ]
  },
  {
    "id": "BUG-017",
    "title": "Immediate URL.revokeObjectURL may cancel downloads",
    "area": "frontend",
    "severity": "low",
    "description": "Object URL revoked immediately after click; can cancel download in some browsers.",
    "file": "frontend/src/components/ExportDialog.tsx",
    "lines": "786-797; 831-840",
    "suggested_fix": "Delay revoke with setTimeout or after download starts.",
    "labels": [
      "bug",
      "frontend",
      "export",
      "compatibility"
    ]
  },
  {
    "id": "BUG-018",
    "title": "Duplicate ControlSurfaceSection component in panels",
    "area": "frontend",
    "severity": "low",
    "description": "ControlSurfaceSection is duplicated in WingPanel and TailConventionalPanel, increasing maintenance risk.",
    "file": "frontend/src/components/panels/WingPanel.tsx; frontend/src/components/panels/TailConventionalPanel.tsx",
    "lines": "17-45; 17-45",
    "suggested_fix": "Extract shared component and reuse.",
    "labels": [
      "bug",
      "frontend",
      "refactor",
      "duplication"
    ]
  },
  {
    "id": "BUG-019",
    "title": "Warning IDs missing in frontend categorization",
    "area": "frontend",
    "severity": "medium",
    "description": "WARNING_DESCRIPTIONS/STRUCTURAL_IDS/PRINT_IDS only cover V01-V06 and V16-V23; V09-V13 and V24-V31 missing, causing misclassification.",
    "file": "frontend/src/lib/validation.ts",
    "lines": "26-49",
    "suggested_fix": "Add all warning IDs/descriptions or send category metadata from backend.",
    "labels": [
      "bug",
      "frontend",
      "validation",
      "ux"
    ]
  },
  {
    "id": "BUG-020",
    "title": "Startup script runs redundant build and lacks error handling",
    "area": "tooling",
    "severity": "low-medium",
    "description": "startup.ps1 runs pnpm build before dev server and does not check pnpm install errors.",
    "file": "startup.ps1",
    "lines": "15-27; 40-41",
    "suggested_fix": "Skip build for dev by default; check $LASTEXITCODE and fail fast.",
    "labels": [
      "bug",
      "tooling",
      "performance"
    ]
  },
  {
    "id": "BUG-021",
    "title": "docker-compose builds full image redundantly for dev",
    "area": "tooling",
    "severity": "low",
    "description": "backend service builds full Dockerfile (incl. frontend build) while frontend dev server runs separately.",
    "file": "docker-compose.yml",
    "lines": "3-4; 17-26",
    "suggested_fix": "Use a dev build target skipping frontend build or separate dev Dockerfile.",
    "labels": [
      "bug",
      "tooling",
      "performance",
      "docker"
    ]
  },
  {
    "id": "BUG-022",
    "title": "Temp directory source of truth is inconsistent across backend",
    "area": "backend",
    "severity": "medium",
    "description": "Main/cleanup use /data/tmp, export uses CHENG_DATA_DIR/tmp, causing inconsistency and cleanup gaps.",
    "file": "backend/main.py; backend/cleanup.py; backend/export/package.py",
    "lines": "48-57; 15-16; 30",
    "suggested_fix": "Define EXPORT_TMP_DIR once and import where needed to keep paths consistent.",
    "labels": [
      "bug",
      "backend",
      "cleanup",
      "storage"
    ]
  }
]