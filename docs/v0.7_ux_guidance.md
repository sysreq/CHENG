# v0.7 UX & Frontend Guidance

> **Audience:** Worker agents implementing v0.7 features.
> **Purpose:** Definitive frontend/UX reference for all five v0.7 issues.
> **Authority:** This document governs all UI decisions for v0.7. When in doubt, follow existing patterns exactly as documented here.

---

## How to Read This Document

Each section covers one GitHub issue. Every section has:
- **What changes** — which files to touch
- **Exact TypeScript additions** — new types/fields with their constraints
- **Store changes** — Zustand state additions
- **UI rendering spec** — precise component structure and behavior
- **3D viewport behavior** — what the user sees change in the canvas
- **Export dialog changes** (where relevant)
- **Validation integration** — how warnings surface in the UI

Read the **General Patterns** section at the end before starting any issue. It contains rules that apply everywhere.

---

## Issue #143 — Multi-Section Wings

### Summary

Add a `wingSections` integer parameter (1–4) that, when greater than 1, reveals per-panel controls for break position, dihedral, and sweep. This enables cranked/polyhedral planforms (e.g., a 3-panel gull wing or classic glider polyhedral).

---

### TypeScript Type Changes

**File:** `frontend/src/types/design.ts`

Add to `AircraftDesign` interface (after `wingTwist`):

```typescript
// ── Multi-Section Wing (Issue #143) ───────────────────────────────
/** Number of spanwise panels per half-wing. 1 = straight, 2–4 = polyhedral/cranked.
 *  @min 1 @max 4 @default 1 @integer */
wingSections: number;
/** Break positions as % of half-span where panel n meets panel n+1.
 *  Array length = wingSections - 1. Values must be strictly increasing 10–90%.
 *  e.g. [60] for 2-section, [40, 70] for 3-section.
 *  @unit % @min 10 @max 90 */
panelBreaks: number[];
/** Dihedral angle per panel starting from panel 2 (panel 1 uses global wingDihedral).
 *  Array length = wingSections - 1.
 *  @unit deg @min -10 @max 45 */
panelDihedrals: number[];
/** Sweep angle override per panel starting from panel 2 (panel 1 uses global wingSweep).
 *  Array length = wingSections - 1. Use wingSweep value as default on creation.
 *  @unit deg @min -10 @max 45 */
panelSweeps: number[];
```

**Defaults** (add to preset factories in `frontend/src/lib/presets.ts`, all presets):

```typescript
wingSections: 1,
panelBreaks: [],
panelDihedrals: [],
panelSweeps: [],
```

**Glider preset exception:** Set `wingSections: 2`, `panelBreaks: [60]`, `panelDihedrals: [10]`, `panelSweeps: [0]` as a sensible polyhedral glider default.

---

### Zustand Store Changes

**File:** `frontend/src/store/designStore.ts`

Add to `PARAM_LABELS`:

```typescript
wingSections: 'Wing Sections',
```

Add helper actions alongside `setParam`:

```typescript
/** Set a specific panel break position by index. */
setPanelBreak: (index: number, value: number) => void;
/** Set a specific panel dihedral by index. */
setPanelDihedral: (index: number, value: number) => void;
/** Set a specific panel sweep by index. */
setPanelSweep: (index: number, value: number) => void;
```

Implement these using `produce` (Immer), modifying `state.design.panelBreaks[index]` etc., and recording `lastAction` as `'Set Panel ${index + 2} Break'` etc. All three must set `isDirty = true` and `activePreset = 'Custom'`.

**Critical:** When `wingSections` changes via `setParam`, a side-effect must resize the arrays:
- Increasing `wingSections` from N to M: append `(M - N)` default entries to `panelBreaks`, `panelDihedrals`, `panelSweeps`. Defaults: break at `Math.round((60 + (index * 15)))` %, dihedral at `10`, sweep equal to current `design.wingSweep`.
- Decreasing `wingSections` from M to N: truncate arrays to length `N - 1`.

Implement this side-effect inside `setParam` using an `if (key === 'wingSections')` branch.

Add `panelBreaks`, `panelDihedrals`, `panelSweeps`, `wingSections` to `PRESET_COMPARE_KEYS`.

---

### WingPanel.tsx Changes

**File:** `frontend/src/components/panels/WingPanel.tsx`

#### Step 1 — Wing Sections Count

Add `wingSections` as a `ParamSlider` immediately **after** the Airfoil `<ParamSelect>` and **before** the Sweep Angle slider. Use integer steps:

```tsx
{/* W08 — Wing Sections */}
<ParamSlider
  label="Wing Sections"
  value={design.wingSections}
  min={1}
  max={4}
  step={1}
  onSliderChange={setSectionsSlider}
  onInputChange={setSectionsInput}
  title="Number of spanwise wing panels per half. 1 = straight, 2–4 = polyhedral or cranked planform."
/>
```

No `unit` prop (it is a count). No `hasWarning` initially (no backend validation defined yet for this field in v0.7).

#### Step 2 — Panel Sub-Sections (Conditional)

After the core Wing parameters block (Sweep, Tip/Root, Dihedral, Incidence, Twist, Skin Thickness) and **before** the Derived Values separator, insert:

```tsx
{design.wingSections > 1 && (
  <div className="mt-3">
    <div className="border-t border-zinc-700/50 mb-3" />
    <h4 className="text-xs font-semibold text-zinc-500 uppercase tracking-wider mb-2">
      Wing Panel Breaks
    </h4>
    {Array.from({ length: design.wingSections - 1 }, (_, i) => (
      <WingPanelSection key={i} index={i} />
    ))}
  </div>
)}
```

#### Step 3 — WingPanelSection Sub-Component

Create a new sub-component **within** `WingPanel.tsx` (not a separate file, to keep the panel self-contained):

```tsx
function WingPanelSection({ index }: { index: number }): React.JSX.Element {
  // Reads from store: design.panelBreaks[index], panelDihedrals[index], panelSweeps[index]
  // Uses store actions: setPanelBreak, setPanelDihedral, setPanelSweep
  // Uses useState for collapse (open by default for index 0, collapsed for higher)
  // ...
}
```

The section renders as a collapsible card using **manual toggle state** (not Radix Collapsible — it is heavy for this use). Pattern: same as `PrintSettingsSection` toggle button approach.

**Card structure:**

```
┌─────────────────────────────────────────────┐
│  ▼  Panel 2 (Inner → Outer break at 60%)    │  ← toggle button header
├─────────────────────────────────────────────┤
│  Break Position        [slider] [input] %   │
│  Outer Dihedral        [slider] [input] deg │
│  Outer Sweep           [slider] [input] deg │
│  [inline error if break position invalid]   │
└─────────────────────────────────────────────┘
```

Header label convention:
- index 0 → "Panel 2" (the outer half starting from break 1)
- index 1 → "Panel 3"
- etc.

The header subtitle shows the current break position inline: `"(break at ${panelBreaks[index]}%)"`. This lets users see values without expanding.

**Break Position slider:** min=10, max=90, step=1, unit=`%`. Add inline validation: if `panelBreaks[i] >= panelBreaks[i+1]` (i.e., breaks are not monotonically increasing), show an inline error message below the slider in red text:

```tsx
{breakIsInvalid && (
  <p className="text-[10px] text-red-400 mt-0.5">
    Break must be less than Panel {index + 3} break ({panelBreaks[index + 1]}%)
  </p>
)}
```

Check: `breakIsInvalid = index < design.panelBreaks.length - 1 && design.panelBreaks[index] >= design.panelBreaks[index + 1]`

**Outer Dihedral slider:** min=-10, max=45, step=0.5, unit=`deg`. Title: `"Dihedral of panel ${index + 2}, measured from horizontal"`.

**Outer Sweep slider:** min=-10, max=45, step=1, unit=`deg`. Title: `"Leading-edge sweep of panel ${index + 2}. Defaults to global sweep when section is created."`.

#### Handler Pattern

All three panel-array fields use a `useCallback` wrapping the new store actions. Since `ParamSlider` requires `onSliderChange` and `onInputChange`, pass the same store action for both (arrays do not need slider/text debounce distinction — use `'immediate'` source semantics):

```tsx
const setBreak = useCallback(
  (v: number) => setPanelBreak(index, v),
  [setPanelBreak, index],
);
```

---

### 3D Viewport Changes

**File:** `frontend/src/components/Viewport/AircraftMesh.tsx`

When `wingSections > 1`, the backend will return additional component ranges in the WebSocket trailer. The frontend needs to handle rendering multiple wing panel components.

**Strategy:** Extend `ComponentRanges` in `types/design.ts` to include panel keys:

```typescript
/** Per-component face index ranges for selection highlighting. */
export type ComponentRanges = Partial<Record<
  'fuselage' | 'wing' | 'tail' |
  'wing_panel_1' | 'wing_panel_2' | 'wing_panel_3' | 'wing_panel_4',
  [number, number]
>>;
```

In `AircraftMesh.tsx`, extend the component loop to include wing panel sub-keys:

```typescript
const WING_PANEL_KEYS = ['wing_panel_1', 'wing_panel_2', 'wing_panel_3', 'wing_panel_4'] as const;
```

When rendering, if `wing_panel_*` keys exist in `componentRanges`, render them as separate meshes under the 'wing' component group. All wing panels:
- Share the same `isSelected` state (clicking any panel selects `'wing'`)
- Panel 1 (innermost) uses `COMPONENT_COLORS.wing` = `'#5c9ce6'` (existing blue)
- Panel 2 uses `'#4a8dd4'` (slightly darker blue)
- Panel 3 uses `'#3a7dc4'` (darker still)
- Panel 4 uses `'#2a6db4'`
- When a wing panel is hovered, show tooltip: `"Wing — Panel ${n}"`
- When any wing panel is clicked, call `setSelectedComponent('wing')` (not a new component type)

This strategy means no changes to `ComponentSelection` type — all panels belong to the existing `'wing'` component. The color differentiation gives visual distinction without adding a new selection flow.

**Sub-element cycling:** When the wing is selected and the user clicks again (cycling sub-elements), the existing `cycleSubElement` will cycle `'left-panel'` / `'right-panel'`. No change needed — but if panel keys exist, extend `COMPONENT_SUB_ELEMENTS.wing` to include them:

Update `types/design.ts`:

```typescript
// Extend dynamically based on wingSections — but since this is a static type,
// provide the full possible set:
export const COMPONENT_SUB_ELEMENTS: Record<...> = {
  wing: ['left-panel', 'right-panel', 'inner-panel', 'mid-panel', 'outer-panel'] as const,
  tail: ['h-stab', 'v-stab'] as const,
  fuselage: ['nose', 'cabin', 'tail-cone'] as const,
};
```

The cycling will only traverse sub-elements that actually exist in the mesh, so extra entries are harmless.

---

### Export/Print Settings Impact

No changes to `ExportDialog.tsx` for this issue. The backend will section multi-panel wings using the same auto-sectioning logic. The export preview parts list will naturally show more wing panel pieces; the existing `componentLabel` function will display them using the `component` field from the backend (extend `componentLabel` to handle `'wing_panel_1'` etc. → `"Wing (Panel 1)"`).

---

## Issue #144 — Control Surfaces

### Summary

Add enable/disable toggles and dimension sliders for ailerons, elevator, rudder, ruddervators, and elevons. Control surfaces appear as collapsible sub-sections within the relevant component panel. Each surface type is visible only when it is applicable to the current tail type and component.

---

### TypeScript Type Changes

**File:** `frontend/src/types/design.ts`

Add to `AircraftDesign` (group after the tail parameters, before the Export/Print section):

```typescript
// ── Control Surfaces (Issue #144) ─────────────────────────────────

// Ailerons (Wing) — C01–C04
/** Enable aileron cutouts on the wing. @default false */
aileronEnable: boolean;
/** Aileron inboard edge as % of half-span from root. @unit % @min 30 @max 70 @default 55 */
aileronSpanStart: number;
/** Aileron outboard edge as % of half-span from root. @unit % @min 70 @max 98 @default 95 */
aileronSpanEnd: number;
/** Aileron chord as % of local wing chord. @unit % @min 15 @max 40 @default 25 */
aileronChordPercent: number;

// Elevator (H-Stab) — C11–C13
/** Enable elevator on H-stab. @default false */
elevatorEnable: boolean;
/** Elevator span as % of total H-stab span. @unit % @min 50 @max 100 @default 100 */
elevatorSpanPercent: number;
/** Elevator chord as % of H-stab chord. @unit % @min 20 @max 50 @default 35 */
elevatorChordPercent: number;

// Rudder (V-Stab) — C15–C17
/** Enable rudder on V-stab. @default false */
rudderEnable: boolean;
/** Rudder height as % of fin height. @unit % @min 50 @max 100 @default 90 */
rudderHeightPercent: number;
/** Rudder chord as % of fin chord. @unit % @min 20 @max 50 @default 35 */
rudderChordPercent: number;

// Ruddervators (V-Tail) — C18–C20
/** Enable ruddervators on V-tail surfaces. @default false */
ruddervatorEnable: boolean;
/** Ruddervator chord as % of V-tail chord. @unit % @min 20 @max 50 @default 35 */
ruddervatorChordPercent: number;
/** Ruddervator span as % of V-tail surface span. @unit % @min 60 @max 100 @default 90 */
ruddervatorSpanPercent: number;

// Elevons (Flying Wing) — C21–C24
/** Enable elevon cutouts (for flying-wing/delta). @default false */
elevonEnable: boolean;
/** Elevon inboard edge as % of half-span. @unit % @min 10 @max 40 @default 20 */
elevonSpanStart: number;
/** Elevon outboard edge as % of half-span. @unit % @min 60 @max 98 @default 90 */
elevonSpanEnd: number;
/** Elevon chord as % of local wing chord. @unit % @min 15 @max 35 @default 20 */
elevonChordPercent: number;
```

**Defaults:** All `*Enable` fields default to `false`. All `*Percent` / `*Start` / `*End` fields use the values listed in `@default` above. These defaults apply to ALL preset factories.

Add to `PARAM_LABELS` in `designStore.ts`:

```typescript
aileronEnable: 'Ailerons',
elevatorEnable: 'Elevator',
rudderEnable: 'Rudder',
ruddervatorEnable: 'Ruddervators',
elevonEnable: 'Elevons',
aileronChordPercent: 'Aileron Chord %',
elevatorChordPercent: 'Elevator Chord %',
rudderChordPercent: 'Rudder Chord %',
```

Add all new fields to `PRESET_COMPARE_KEYS`.

---

### WingPanel.tsx — Ailerons Section

**File:** `frontend/src/components/panels/WingPanel.tsx`

Add a collapsible "Ailerons" sub-section **after** the Wing Skin Thickness slider and **before** the Derived Values separator. The section is always present in `WingPanel` (not dependent on tailType).

**Exception for Flying Wing:** When `design.tailType === 'FlyingWing'` (note: the current type system uses `TailType = 'Conventional' | 'T-Tail' | 'V-Tail' | 'Cruciform'` — a `'FlyingWing'` TailType value does not currently exist. Flying-Wing mode is detected via preset. For v0.7, check `design.fuselagePreset === 'Blended-Wing-Body'` as a proxy until a proper FlyingWing tail type is added). Show "Elevons" instead of "Ailerons" when this condition is true.

**Aileron section UI:**

```
┌─ Ailerons ──────────────────────────────────── [▼] ─┐
│  [✓] Enable Ailerons                                  │
│  ── when enabled ───────────────────────────────────  │
│  Aileron Inboard      [slider] [input] %              │
│  Aileron Outboard     [slider] [input] %              │
│  Aileron Chord %      [slider] [input] %              │
└─────────────────────────────────────────────────────┘
```

Toggle header pattern: same as `PrintSettingsSection` — a button with expand/collapse triangle. The sub-controls are hidden when collapsed. The `aileronEnable` toggle is always visible even when collapsed (so the user can enable/disable without expanding).

**Toggle control:** Use `ParamToggle` for `aileronEnable`. When disabled (not enabled), the three slider controls are rendered but with `disabled={true}`. This is the correct pattern — do not conditionally unmount them, as that loses user-entered values when toggling.

**Slider ranges:**
- Aileron Inboard: min=30, max=70, step=1, unit=`%`
- Aileron Outboard: min=70, max=98, step=1, unit=`%`
- Aileron Chord %: min=15, max=40, step=1, unit=`%`

**Titles:**
- `aileronSpanStart`: `"Inboard edge of aileron as % of half-span from root. Must be less than outboard edge."`
- `aileronSpanEnd`: `"Outboard edge of aileron as % of half-span. 95% leaves a small wingtip gap."`
- `aileronChordPercent`: `"Aileron chord as % of the local wing chord at that spanwise station."`

**Elevon section UI** (when `fuselagePreset === 'Blended-Wing-Body'`):

Replace the Ailerons section header with "Elevons". Show:
- `ParamToggle` for `elevonEnable`
- `elevonSpanStart` slider (min=10, max=40, step=1, label="Elevon Inboard", unit=`%`)
- `elevonSpanEnd` slider (min=60, max=98, step=1, label="Elevon Outboard", unit=`%`)
- `elevonChordPercent` slider (min=15, max=35, step=1, label="Elevon Chord %", unit=`%`)
- Title on section: `"For flying-wing/delta configurations. Elevons combine aileron and elevator function."`

---

### TailConventionalPanel.tsx — Elevator & Rudder

**File:** `frontend/src/components/panels/TailConventionalPanel.tsx`

Add two collapsible sub-sections: one under the H-Stab group, one under the V-Stab group.

**Elevator sub-section** (place after `hStabIncidence` slider, before the V-Stab separator):

```
┌─ Elevator ──────────────────────────────────── [▼] ─┐
│  [✓] Enable Elevator                                  │
│  Elevator Span %      [slider] [input] %              │
│  Elevator Chord %     [slider] [input] %              │
└─────────────────────────────────────────────────────┘
```

Slider ranges:
- Elevator Span %: min=50, max=100, step=1, title=`"Elevator span as % of total H-stab span."`
- Elevator Chord %: min=20, max=50, step=1, title=`"Elevator chord as % of H-stab chord. 35% is typical."`

**Rudder sub-section** (place after `vStabRootChord` slider, before the Shared/Tail Arm separator):

```
┌─ Rudder ────────────────────────────────────── [▼] ─┐
│  [✓] Enable Rudder                                    │
│  Rudder Height %      [slider] [input] %              │
│  Rudder Chord %       [slider] [input] %              │
└─────────────────────────────────────────────────────┘
```

Slider ranges:
- Rudder Height %: min=50, max=100, step=1, title=`"Rudder height as % of V-stab height."`
- Rudder Chord %: min=20, max=50, step=1, title=`"Rudder chord as % of fin root chord."`

---

### TailVTailPanel.tsx — Ruddervators

**File:** `frontend/src/components/panels/TailVTailPanel.tsx`

Add a collapsible "Ruddervators" sub-section after the `vTailSweep` slider and before the Shared separator:

```
┌─ Ruddervators ──────────────────────────────── [▼] ─┐
│  [✓] Enable Ruddervators                              │
│  Ruddervator Chord %  [slider] [input] %              │
│  Ruddervator Span %   [slider] [input] %              │
└─────────────────────────────────────────────────────┘
```

Add a title to the section header: `"Ruddervators combine elevator and rudder function on V-tail surfaces."`.

Slider ranges:
- Chord %: min=20, max=50, step=1
- Span %: min=60, max=100, step=1

---

### Collapsible Section Pattern

All control surface sections follow the same pattern (do not use Radix Collapsible — use manual toggle like `PrintSettingsSection`):

```tsx
function ControlSurfaceSection({
  title,
  tooltip,
  children,
}: {
  title: string;
  tooltip?: string;
  children: React.ReactNode;
}): React.JSX.Element {
  const [isOpen, setIsOpen] = useState(false);
  return (
    <div className="mt-3">
      <div className="border-t border-zinc-700/50 mb-2" />
      <button
        onClick={() => setIsOpen(v => !v)}
        type="button"
        className="flex items-center justify-between w-full text-left
          focus:outline-none focus:ring-1 focus:ring-blue-500 rounded px-1 py-0.5"
        aria-expanded={isOpen}
        title={tooltip}
      >
        <span className="text-xs font-semibold text-zinc-500 uppercase tracking-wider">
          {title}
        </span>
        <span className="text-xs text-zinc-500">{isOpen ? '▲' : '▼'}</span>
      </button>
      {isOpen && <div className="mt-2 space-y-0">{children}</div>}
    </div>
  );
}
```

This is a local component defined within the panel file that uses it. It does **not** need to be exported or placed in `components/ui/` — it is panel-local infrastructure.

---

### 3D Viewport Changes for Control Surfaces

**File:** `frontend/src/components/Viewport/AircraftMesh.tsx`

Extend `ComponentRanges` to include control surface face range keys:

```typescript
export type ComponentRanges = Partial<Record<
  'fuselage' | 'wing' | 'tail' |
  'wing_panel_1' | 'wing_panel_2' | 'wing_panel_3' | 'wing_panel_4' |
  'aileron_left' | 'aileron_right' |
  'elevator' | 'rudder' |
  'ruddervator_left' | 'ruddervator_right' |
  'elevon_left' | 'elevon_right',
  [number, number]
>>;
```

Extend `COMPONENT_COLORS` (add to the record):

```typescript
aileron_left: '#f59e0b',   // amber — control surface highlight
aileron_right: '#f59e0b',
elevator: '#f59e0b',
rudder: '#f59e0b',
ruddervator_left: '#f59e0b',
ruddervator_right: '#f59e0b',
elevon_left: '#f59e0b',
elevon_right: '#f59e0b',
```

Extend `componentLabel` in `ExportDialog.tsx`:

```typescript
case 'aileron_left': return 'Aileron (Left)';
case 'aileron_right': return 'Aileron (Right)';
case 'elevator': return 'Elevator';
case 'rudder': return 'Rudder';
case 'ruddervator_left': return 'Ruddervator (Left)';
case 'ruddervator_right': return 'Ruddervator (Right)';
case 'elevon_left': return 'Elevon (Left)';
case 'elevon_right': return 'Elevon (Right)';
```

Extend `componentColor` in `ExportDialog.tsx` (add cases for all control surface keys → use the amber color family `{ fill: '#f59e0b22', stroke: '#f59e0b', text: '#f59e0b' }`).

**Click behavior for control surfaces:** Clicking a control surface mesh in the viewport should select its parent component:
- `aileron_*`, `elevon_*` → `setSelectedComponent('wing')`
- `elevator`, `rudder`, `ruddervator_*` → `setSelectedComponent('tail')`

This keeps the selection model simple. The control surface is not itself a selectable component with its own panel — it is a sub-element of wing or tail.

**AircraftMesh loop extension:** In the component rendering loop (the `(['fuselage', 'wing', 'tail'] as const).map(...)` section), add a second pass after the three main components for control surface keys. These should render as a separate group with a slightly raised emissive to give them visual distinctness:

```tsx
{/* Control surface overlay meshes */}
{(['aileron_left', 'aileron_right', 'elevator', 'rudder',
   'ruddervator_left', 'ruddervator_right', 'elevon_left', 'elevon_right'] as const)
  .map((key) => {
    const geom = componentGeometries[key];
    if (!geom) return null;
    // Always amber, slight emissive, not independently selectable
    return (
      <mesh key={key} geometry={geom}>
        <meshStandardMaterial
          color="#f59e0b"
          emissive="#331a00"
          emissiveIntensity={0.4}
          metalness={0.05}
          roughness={0.6}
          side={THREE.DoubleSide}
        />
      </mesh>
    );
  })}
```

**Deflection arc annotation:** This is a read-only visual overlay. Implement as an `<Html>` element (from `@react-three/drei`) positioned near each control surface's bounding sphere center when the control surface's parent component is selected. Show a simple SVG arc indicating the max deflection range:

- Ailerons: show ±25° arc annotation near the wing tip area
- Elevator: show ±25° arc near the h-stab
- Rudder: show ±30° arc near the v-stab

The annotation is a `<div>` with a small SVG arc and a label `"±25°"`. Do not implement actual 3D arc geometry — use a 2D HTML overlay. Style consistently with the existing sub-element tooltip style in `AircraftMesh.tsx` (dark background, 1px border, monospace font).

Visibility condition: show deflection annotations only when `selectedComponent === 'wing'` (for ailerons) or `selectedComponent === 'tail'` (for elevator/rudder), AND the corresponding enable flag is true (`design.aileronEnable`, etc.).

---

### Export Dialog Changes

**File:** `frontend/src/components/ExportDialog.tsx`

No structural changes needed. The export preview parts list will automatically show control surface components when they are enabled, since the backend returns them as separate section parts. The existing `componentColor` and `componentLabel` helpers need updating (done above).

Add a note to the per-component Print Settings concept: control surfaces use their parent component's print settings (wing print settings apply to ailerons; tail print settings apply to elevator/rudder). The `PrintSettingsSection` component does not need a new control surface variant.

---

## Issue #145 — Landing Gear Parameters

### Summary

Add a new `LandingGearPanel` component accessible when the `'landing_gear'` component is selected in the viewport. Also add landing gear as a new tab/entry in the component selection system. The panel shows gear type selection and conditional parameter groups.

---

### TypeScript Type Changes

**File:** `frontend/src/types/design.ts`

Add a new type for gear configuration:

```typescript
/** Landing gear configuration type. */
export type LandingGearType = 'None' | 'Tricycle' | 'Taildragger';
```

Add to `ComponentSelection`:

```typescript
export type ComponentSelection = 'wing' | 'tail' | 'fuselage' | 'landing_gear' | null;
```

Update `COMPONENT_SUB_ELEMENTS` with a landing gear entry:

```typescript
landing_gear: ['main_left', 'main_right', 'nose_gear', 'tail_wheel'] as const,
```

Add to `AircraftDesign` (after the Fuselage Wall Thickness section, before Export/Print):

```typescript
// ── Landing Gear (Issue #145) ─────────────────────────────────────
/** Landing gear configuration. @default 'None' */
landingGearType: LandingGearType;
/** Main gear longitudinal position as % of fuselage length from nose.
 *  @unit % @min 25 @max 55 @default 35 */
mainGearPosition: number;
/** Main gear strut height (ground clearance). @unit mm @min 15 @max 150 @default 40 */
mainGearHeight: number;
/** Lateral distance between left and right main wheels. @unit mm @min 30 @max 400 @default 120 */
mainGearTrack: number;
/** Main wheel diameter. @unit mm @min 10 @max 80 @default 30 */
mainWheelDiameter: number;
/** Nose gear strut height (Tricycle only). @unit mm @min 15 @max 150 @default 45 */
noseGearHeight: number;
/** Nose wheel diameter (Tricycle only). @unit mm @min 8 @max 60 @default 20 */
noseWheelDiameter: number;
/** Tail wheel diameter (Taildragger only). @unit mm @min 5 @max 40 @default 12 */
tailWheelDiameter: number;
/** Tail gear longitudinal position as % of fuselage length from nose (Taildragger only).
 *  @unit % @min 85 @max 98 @default 92 */
tailGearPosition: number;
```

**Defaults for all presets:** `landingGearType: 'None'`, all numeric params at their `@default` values.

**PRESET_COMPARE_KEYS:** Add all new landing gear fields.

**PARAM_LABELS:** Add:

```typescript
landingGearType: 'Landing Gear Type',
mainGearPosition: 'Main Gear Position',
mainGearHeight: 'Main Gear Height',
mainGearTrack: 'Main Gear Track',
mainWheelDiameter: 'Main Wheel Dia',
noseGearHeight: 'Nose Gear Height',
noseWheelDiameter: 'Nose Wheel Dia',
tailWheelDiameter: 'Tail Wheel Dia',
tailGearPosition: 'Tail Gear Position',
```

---

### New File: LandingGearPanel.tsx

**File:** `frontend/src/components/panels/LandingGearPanel.tsx`

This is a new file. Model it on `FuselagePanel.tsx`. Full structure:

```tsx
// ============================================================================
// CHENG — Landing Gear Panel: Gear type selection + conditional parameters
// Issue #145
// ============================================================================

import React, { useCallback } from 'react';
import { useDesignStore } from '../../store/designStore';
import { ParamSlider, ParamSelect } from '../ui';
import { PrintSettingsSection } from './PrintSettingsSection';
import type { LandingGearType } from '../../types/design';

const GEAR_TYPE_OPTIONS: readonly LandingGearType[] = [
  'None',
  'Tricycle',
  'Taildragger',
] as const;

export function LandingGearPanel(): React.JSX.Element {
  const design = useDesignStore((s) => s.design);
  const setParam = useDesignStore((s) => s.setParam);

  const setGearType = useCallback(
    (v: LandingGearType) => setParam('landingGearType', v, 'immediate'),
    [setParam],
  );

  // ... handlers for all sliders (same pattern as existing panels)

  const hasSomeGear = design.landingGearType !== 'None';
  const isTricycle = design.landingGearType === 'Tricycle';
  const isTaildragger = design.landingGearType === 'Taildragger';

  return (
    <div className="p-3">
      <h3 className="text-xs font-semibold text-zinc-400 uppercase tracking-wider mb-3">
        Landing Gear
      </h3>

      {/* L01 — Gear Type */}
      <ParamSelect
        label="Gear Type"
        value={design.landingGearType}
        options={GEAR_TYPE_OPTIONS}
        onChange={setGearType}
        title="None = belly landing. Tricycle = nose wheel + two mains. Taildragger = two mains + rear tail wheel."
      />

      {/* None — info message */}
      {!hasSomeGear && (
        <p className="text-[10px] text-zinc-500 leading-relaxed mb-3">
          No landing gear will be generated. The plane belly-lands. Select Tricycle or
          Taildragger to add printed gear struts.
        </p>
      )}

      {/* Main Gear — shown for Tricycle and Taildragger */}
      {hasSomeGear && (
        <>
          <div className="border-t border-zinc-700/50 mt-3 mb-2" />
          <h4 className="text-[10px] font-medium text-zinc-500 uppercase mb-2">
            Main Gear
          </h4>

          {/* L03 — Main Gear Position */}
          <ParamSlider
            label="Position"
            unit="%"
            value={design.mainGearPosition}
            min={25}
            max={55}
            step={1}
            onSliderChange={...}
            onInputChange={...}
            title="Longitudinal position of main gear axle as % of fuselage length from nose. Should be behind the CG for tricycle, at/near CG for taildragger."
          />

          {/* L04 — Main Gear Height */}
          <ParamSlider
            label="Strut Height"
            unit="mm"
            value={design.mainGearHeight}
            min={15}
            max={150}
            step={1}
            onSliderChange={...}
            onInputChange={...}
            title="Height of the main gear strut. Determines ground clearance for the propeller and fuselage."
          />

          {/* L05 — Main Gear Track */}
          <ParamSlider
            label="Track Width"
            unit="mm"
            value={design.mainGearTrack}
            min={30}
            max={400}
            step={5}
            onSliderChange={...}
            onInputChange={...}
            title="Lateral distance between left and right main wheel axles."
          />

          {/* L06 — Main Wheel Diameter */}
          <ParamSlider
            label="Wheel Diameter"
            unit="mm"
            value={design.mainWheelDiameter}
            min={10}
            max={80}
            step={1}
            onSliderChange={...}
            onInputChange={...}
            title="Main wheel diameter. Match to your purchased wheels or print custom wheels."
          />
        </>
      )}

      {/* Nose Gear — Tricycle only */}
      {isTricycle && (
        <>
          <div className="border-t border-zinc-700/50 mt-3 mb-2" />
          <h4 className="text-[10px] font-medium text-zinc-500 uppercase mb-2">
            Nose Gear
          </h4>

          {/* L08 — Nose Gear Height */}
          <ParamSlider
            label="Strut Height"
            unit="mm"
            value={design.noseGearHeight}
            min={15}
            max={150}
            step={1}
            onSliderChange={...}
            onInputChange={...}
            title="Nose gear strut height. Should be similar to or slightly shorter than the main gear height for level ground stance."
          />

          {/* L09 — Nose Wheel Diameter */}
          <ParamSlider
            label="Wheel Diameter"
            unit="mm"
            value={design.noseWheelDiameter}
            min={8}
            max={60}
            step={1}
            onSliderChange={...}
            onInputChange={...}
            title="Nose wheel diameter. Usually smaller than main wheels."
          />
        </>
      )}

      {/* Tail Wheel — Taildragger only */}
      {isTaildragger && (
        <>
          <div className="border-t border-zinc-700/50 mt-3 mb-2" />
          <h4 className="text-[10px] font-medium text-zinc-500 uppercase mb-2">
            Tail Wheel
          </h4>

          {/* L10 — Tail Wheel Diameter */}
          <ParamSlider
            label="Wheel Diameter"
            unit="mm"
            value={design.tailWheelDiameter}
            min={5}
            max={40}
            step={1}
            onSliderChange={...}
            onInputChange={...}
            title="Tail wheel diameter. Usually much smaller than main wheels (e.g. 12mm vs 30mm mains)."
          />

          {/* L11 — Tail Gear Position */}
          <ParamSlider
            label="Position"
            unit="%"
            value={design.tailGearPosition}
            min={85}
            max={98}
            step={1}
            onSliderChange={...}
            onInputChange={...}
            title="Longitudinal position of tail wheel as % of fuselage length from nose. Typically near the very tail of the fuselage."
          />
        </>
      )}

      {/* Material note for printed gear */}
      {hasSomeGear && (
        <div className="mt-3 px-2 py-2 text-[10px] text-amber-200 bg-amber-900/20
          border border-amber-700/30 rounded leading-relaxed">
          Note: Printed PLA gear struts can be fragile. Consider PETG/Nylon for struts,
          or use music wire in printed guide brackets.
        </div>
      )}

      {/* Per-Component Print Settings */}
      <PrintSettingsSection component="landing_gear" />
    </div>
  );
}
```

**Important:** `PrintSettingsSection` currently only accepts `'wing' | 'tail' | 'fuselage'`. Extend its prop type and the `PerComponentPrintSettings` type:

```typescript
// In types/design.ts:
export type PerComponentPrintSettings = Partial<Record<
  'wing' | 'tail' | 'fuselage' | 'landing_gear',
  ComponentPrintSettings
>>;

// In designStore.ts setComponentPrintSetting signature:
setComponentPrintSetting: (
  component: 'wing' | 'tail' | 'fuselage' | 'landing_gear',
  settings: Partial<ComponentPrintSettings>,
) => void;
```

---

### ComponentPanel.tsx Changes

**File:** `frontend/src/components/panels/ComponentPanel.tsx`

Import `LandingGearPanel` and add a routing branch:

```tsx
import { LandingGearPanel } from './LandingGearPanel';

// In the routing logic, add after the fuselage branch:
if (selectedComponent === 'landing_gear') {
  return <LandingGearPanel />;
}
```

Update the default "nothing selected" message to remain unchanged.

---

### 3D Viewport Changes

**File:** `frontend/src/components/Viewport/AircraftMesh.tsx`

Extend `ComponentRanges`:

```typescript
'main_gear_left' | 'main_gear_right' | 'nose_gear' | 'tail_wheel'
```

Extend `COMPONENT_COLORS`:

```typescript
main_gear_left: '#22c55e',
main_gear_right: '#22c55e',
nose_gear: '#22c55e',
tail_wheel: '#22c55e',
```

Landing gear meshes are clickable and select `'landing_gear'` component. This means gear meshes need their own click handler that calls `setSelectedComponent('landing_gear')`.

Extend the `componentLabels` mapping in `AircraftMesh.tsx`:

```typescript
main_gear_left: 'Landing Gear (Main Left)',
main_gear_right: 'Landing Gear (Main Right)',
nose_gear: 'Landing Gear (Nose)',
tail_wheel: 'Landing Gear (Tail Wheel)',
```

For the rendering loop, landing gear components are treated the same as wing/tail/fuselage: they participate in the selected/unselected color scheme. When `selectedComponent === 'landing_gear'`, gear meshes show yellow (`SELECTED_COLOR`); all other meshes dim to `UNSELECTED_COLOR`.

---

### Export Dialog Changes

**File:** `frontend/src/components/ExportDialog.tsx`

Extend `componentColor`:

```typescript
case 'main_gear_left':
case 'main_gear_right':
case 'nose_gear':
case 'tail_wheel':
  return { fill: '#22c55e22', stroke: '#22c55e', text: '#22c55e' };
```

Extend `componentLabel`:

```typescript
case 'main_gear_left': return 'Main Gear (Left)';
case 'main_gear_right': return 'Main Gear (Right)';
case 'nose_gear': return 'Nose Gear';
case 'tail_wheel': return 'Tail Wheel';
```

STL export naming (the backend handles this, but for reference): parts should be named `main_gear_left.stl`, `main_gear_right.stl`, `nose_gear.stl`, `tail_wheel.stl`.

---

## Issue #146 — Test Joint Feature

### Summary

Add a "Print Test Joint" button in the Export Dialog's Sectioning section. This triggers a lightweight backend call that generates and downloads a small test piece demonstrating the current joint profile. This is a new UI action, not a new parameter.

---

### No TypeScript Type Changes

No new parameters in `AircraftDesign`. The test joint export uses the existing joint parameters: `jointType`, `jointTolerance`, `sectionOverlap`.

---

### ExportDialog.tsx Changes

**File:** `frontend/src/components/ExportDialog.tsx`

#### New State

Add to component state:

```typescript
const [isExportingTestJoint, setIsExportingTestJoint] = useState(false);
const [testJointError, setTestJointError] = useState<string | null>(null);
const [testJointSuccess, setTestJointSuccess] = useState(false);
```

#### New Handler

Add alongside the other export handlers:

```typescript
const handleTestJointExport = useCallback(async () => {
  setIsExportingTestJoint(true);
  setTestJointError(null);
  setTestJointSuccess(false);

  try {
    const res = await fetch('/api/export/test-joint', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        jointType: design.jointType,
        jointTolerance: design.jointTolerance,
        sectionOverlap: design.sectionOverlap,
        nozzleDiameter: design.nozzleDiameter,
      }),
    });

    if (!res.ok) {
      const detail = await res.text().catch(() => '');
      throw new Error(detail || `Test joint export failed (${res.status})`);
    }

    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'test_joint.zip';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    setTestJointSuccess(true);
  } catch (err) {
    const msg = err instanceof Error ? err.message : 'Test joint export failed';
    setTestJointError(msg);
  } finally {
    setIsExportingTestJoint(false);
  }
}, [design.jointType, design.jointTolerance, design.sectionOverlap, design.nozzleDiameter]);
```

#### Placement in Settings Step

Insert the Test Joint section **within the STL-only settings block** (`{hasSectioning && (...)}`) immediately **after** the `<ParamSlider>` for Joint Tolerance and **before** the "Print Settings" sub-heading. This placement is deliberate: the user has just set their joint type and tolerance, so the test joint button is contextually adjacent.

```tsx
{/* ── Test Joint (#146) ─────────────────────────────────────── */}
<div className="mt-3 mb-3 p-3 bg-zinc-800/40 border border-zinc-700/50 rounded-lg">
  <div className="flex items-start justify-between gap-3 mb-2">
    <div className="flex-1">
      <p className="text-xs font-semibold text-zinc-200 mb-0.5">
        Print Test Joint
      </p>
      <p className="text-[10px] text-zinc-400 leading-relaxed">
        Print this small test piece to verify your joint tolerance fits before
        printing the full plane. Takes ~15–30 min on a typical FDM printer.
      </p>
    </div>
  </div>

  {/* Current joint settings summary */}
  <div className="grid grid-cols-3 gap-1.5 mb-3">
    <div className="px-2 py-1 text-[10px] text-zinc-300 bg-zinc-800 border border-zinc-700/50 rounded text-center">
      <div className="text-zinc-500 mb-0.5">Type</div>
      {design.jointType.split('-')[0]}
    </div>
    <div className="px-2 py-1 text-[10px] text-zinc-300 bg-zinc-800 border border-zinc-700/50 rounded text-center">
      <div className="text-zinc-500 mb-0.5">Tolerance</div>
      ±{design.jointTolerance.toFixed(2)} mm
    </div>
    <div className="px-2 py-1 text-[10px] text-zinc-300 bg-zinc-800 border border-zinc-700/50 rounded text-center">
      <div className="text-zinc-500 mb-0.5">Overlap</div>
      {design.sectionOverlap} mm
    </div>
  </div>

  {/* Test joint diagram — static SVG schematic */}
  <TestJointDiagram
    jointType={design.jointType}
    tolerance={design.jointTolerance}
    overlap={design.sectionOverlap}
  />

  {/* Download button */}
  <button
    onClick={handleTestJointExport}
    disabled={isExportingTestJoint}
    className="w-full mt-3 px-4 py-2 text-xs font-medium text-zinc-100
      bg-emerald-700 hover:bg-emerald-600 rounded
      focus:outline-none focus:ring-2 focus:ring-emerald-400
      disabled:opacity-50 disabled:cursor-not-allowed
      inline-flex items-center justify-center gap-1.5
      transition-colors"
  >
    {isExportingTestJoint ? (
      <>
        <span className="generating-spinner" style={{ width: 14, height: 14, borderWidth: 2 }} />
        Generating Test Joint...
      </>
    ) : (
      'Download Test Joint (ZIP)'
    )}
  </button>

  {testJointSuccess && (
    <p className="mt-2 text-[10px] text-emerald-300 text-center">
      Downloaded. Print and check the fit before exporting the full plane.
    </p>
  )}
  {testJointError && (
    <p className="mt-2 text-[10px] text-red-400">{testJointError}</p>
  )}
</div>
```

**Use emerald/green color** (`bg-emerald-700`) to distinguish this button from the primary blue "Export Preview" action. The semantic difference is: test joint = a verification tool, not the main export path.

---

### TestJointDiagram Sub-Component

Create a small SVG diagram within `ExportDialog.tsx` (file-local, not exported) that schematically shows two blocks with a joint cross-section:

```tsx
function TestJointDiagram({
  jointType,
  tolerance,
  overlap,
}: {
  jointType: JointType;
  tolerance: number;
  overlap: number;
}): React.JSX.Element {
  // Simple SVG: two rectangles with a cross-section line showing the joint profile
  // Left block = "Part A", right block = "Part B", center line = joint interface
  // For Tongue-and-Groove: show a small T-shape protruding from center
  // For Dowel-Pin: show dots at the interface
  // For Flat-with-Alignment-Pins: show a flat line with dots
  const svgW = 240;
  const svgH = 80;
  const blockW = 90;
  const blockH = 50;
  const ox = (svgW - blockW * 2 - 20) / 2;
  const oy = (svgH - blockH) / 2;

  return (
    <svg
      width={svgW}
      height={svgH}
      className="w-full bg-zinc-800/50 border border-zinc-700/50 rounded"
    >
      {/* Part A */}
      <rect x={ox} y={oy} width={blockW} height={blockH}
        fill="#4a9eff22" stroke="#4a9eff" strokeWidth={1} rx={2} />
      <text x={ox + blockW / 2} y={oy + blockH / 2 + 4}
        textAnchor="middle" fontSize={9} fill="#4a9eff">Part A</text>

      {/* Part B */}
      <rect x={ox + blockW + 20} y={oy} width={blockW} height={blockH}
        fill="#22c55e22" stroke="#22c55e" strokeWidth={1} rx={2} />
      <text x={ox + blockW + 20 + blockW / 2} y={oy + blockH / 2 + 4}
        textAnchor="middle" fontSize={9} fill="#22c55e">Part B</text>

      {/* Joint interface visualization */}
      {jointType === 'Tongue-and-Groove' && (
        <>
          {/* Tongue */}
          <rect
            x={ox + blockW - 1}
            y={oy + blockH * 0.3}
            width={22}
            height={blockH * 0.4}
            fill="#f59e0b44"
            stroke="#f59e0b"
            strokeWidth={1}
          />
        </>
      )}
      {jointType === 'Dowel-Pin' && (
        <>
          <circle cx={ox + blockW + 10} cy={oy + blockH * 0.35} r={3} fill="#f59e0b" />
          <circle cx={ox + blockW + 10} cy={oy + blockH * 0.65} r={3} fill="#f59e0b" />
        </>
      )}
      {jointType === 'Flat-with-Alignment-Pins' && (
        <>
          <line
            x1={ox + blockW} y1={oy} x2={ox + blockW + 20} y2={oy + blockH}
            stroke="#555" strokeWidth={1} strokeDasharray="3 2" />
          <circle cx={ox + blockW + 10} cy={oy + blockH * 0.5} r={3} fill="#f59e0b" />
        </>
      )}

      {/* Dimension annotation: overlap */}
      <line
        x1={ox + blockW - overlap * 0.3}
        y1={oy + blockH + 8}
        x2={ox + blockW + 20 + overlap * 0.3}
        y2={oy + blockH + 8}
        stroke="#888" strokeWidth={0.5} />
      <text
        x={ox + blockW + 10}
        y={oy + blockH + 17}
        textAnchor="middle"
        fontSize={8}
        fill="#888">
        {overlap}mm overlap
      </text>
    </svg>
  );
}
```

The diagram is schematic, not precise geometry. Its purpose is to communicate the concept, not to be technically accurate. The overlap dimension annotation uses a simplified pixel-to-mm scaling approximation — do not attempt pixel-perfect rendering.

---

### State Cleanup

When the dialog closes (the existing `useEffect` on `!open`), reset test joint state:

```typescript
useEffect(() => {
  if (!open) {
    setStep('settings');
    setPreviewData(null);
    setExportError(null);
    setExportSuccess(false);
    setTestJointError(null);       // add this
    setTestJointSuccess(false);    // add this
  }
}, [open]);
```

---

## Issue #147 — Smart Split-Point Optimizer

### Summary

No new user-configurable parameters. The optimizer runs automatically on the backend when generating section cuts. The UI's job is to: (1) surface split position information in the export preview, (2) show a warning if a split was adjusted from its ideal midpoint, and (3) provide an optional "Show Sections" overlay in the 3D viewport.

---

### TypeScript Type Changes

**File:** `frontend/src/types/design.ts`

Extend `ExportPreviewPart` with split metadata:

```typescript
export interface ExportPreviewPart {
  filename: string;
  component: string;
  side: string;
  sectionNum: number;
  totalSections: number;
  dimensionsMm: [number, number, number];
  printOrientation: string;
  assemblyOrder: number;
  fitsBed: boolean;
  /** Actual cut position in mm from the component origin. @optional — only present for
   *  components with multiple sections. */
  cutPositionMm?: number;
  /** Whether this cut was adjusted away from the midpoint to avoid an internal feature.
   *  @optional */
  cutAdjusted?: boolean;
  /** Human-readable reason for adjustment, e.g. "Avoided spar channel". @optional */
  cutAdjustReason?: string;
}
```

---

### ExportDialog.tsx Changes

**File:** `frontend/src/components/ExportDialog.tsx`

#### Part List Rows — Split Position Display

In the `ExportPreviewPanel` component, extend each part row to show cut position metadata. Add after the dimensions line:

```tsx
{/* Cut position info — for multi-section parts */}
{part.cutPositionMm !== undefined && (
  <div className="text-zinc-500 text-[10px]">
    Cut at {part.cutPositionMm.toFixed(1)} mm
    {part.cutAdjusted && (
      <span className="ml-1 text-amber-400" title={part.cutAdjustReason ?? 'Cut position was adjusted'}>
        adjusted
      </span>
    )}
  </div>
)}
```

When `cutAdjusted` is true, the word "adjusted" appears in amber (`text-amber-400`) with a tooltip containing the reason string (e.g., "Avoided spar channel"). This is a subtle but discoverable indicator.

#### Section Lines in Bed Visualization

Extend `BedVisualization` to draw dashed section cut lines overlaid on the wing and fuselage rectangles. The existing visualization already draws component footprints; add cut lines at their section boundaries.

Since `BedVisualization` does not currently receive `ExportPreviewResponse` data (it only shows a schematic from design params), this enhancement is **only available in the preview step** via a new `BedPreviewVisualization` component.

Add a `BedPreviewVisualization` sub-component in `ExportDialog.tsx` that replaces the schematic `BedVisualization` in the preview step. This component receives `preview: ExportPreviewResponse` and draws all parts with their actual dimensions and shows cut lines:

```tsx
function BedPreviewVisualization({ preview }: { preview: ExportPreviewResponse }): React.JSX.Element {
  // Group parts by component+side
  // Draw each part as a rectangle scaled to SVG space
  // Draw dashed vertical/horizontal lines at cut positions
  // Color parts by componentColor()
  // Mark adjusted cuts with a different dash pattern and amber color

  // ... SVG rendering logic
  // The cut line for an adjusted cut uses: stroke="#f59e0b" strokeDasharray="4 2"
  // The cut line for a normal cut uses: stroke="#555" strokeDasharray="3 3"
}
```

Place `BedPreviewVisualization` at the top of `ExportPreviewPanel`, before the parts grid. This gives users an at-a-glance spatial overview of how the plane is sectioned.

#### Optimizer Warning Banner

Add to `ExportPreviewPanel`, between the summary stats and the bed dimensions reminder:

```tsx
{/* Adjusted cuts warning */}
{preview.parts.some(p => p.cutAdjusted) && (
  <div className="mb-3 px-3 py-2 text-[10px] text-amber-200 bg-amber-900/30
    border border-amber-700/40 rounded leading-relaxed">
    {preview.parts.filter(p => p.cutAdjusted).length} section cut(s) were moved
    from the ideal midpoint to avoid internal features. Check the "adjusted" markers
    in the parts list below for details.
  </div>
)}
```

---

### 3D Viewport "Show Sections" Overlay

**File:** `frontend/src/components/Viewport/Scene.tsx` (or a new `SectionOverlay.tsx`)

Add a "Show Sections" toggle button to the viewport toolbar area. This is an advanced feature — place it in the viewport controls panel, not the main toolbar.

**Step 1 — Store the overlay state**

Add to `designStore.ts` (outside the undoable partialize, as UI-only state):

```typescript
showSectionOverlay: boolean;
toggleSectionOverlay: () => void;
```

Implementation:

```typescript
showSectionOverlay: false,
toggleSectionOverlay: () => set(s => ({ showSectionOverlay: !s.showSectionOverlay })),
```

**Step 2 — Toggle button in Controls**

**File:** `frontend/src/components/Viewport/Controls.tsx`

Add a "Sections" toggle button alongside the existing view buttons (Top, Front, Side, Perspective). Style it as a toggle that lights up when active:

```tsx
<button
  onClick={toggleSectionOverlay}
  title="Toggle section cut overlay (S)"
  className={`px-2 py-1 text-[10px] font-medium rounded border transition-colors
    focus:outline-none focus:ring-1 focus:ring-blue-500
    ${showSectionOverlay
      ? 'bg-amber-500/20 border-amber-500/50 text-amber-200'
      : 'bg-zinc-800/50 border-zinc-700/50 text-zinc-400 hover:bg-zinc-700/50'
    }`}
>
  Sections
</button>
```

**Step 3 — Section plane rendering in Scene**

**File:** `frontend/src/components/Viewport/Scene.tsx`

When `showSectionOverlay` is true and `meshData` is available, render a set of transparent plane meshes at each section cut position. The backend must supply cut positions via the WebSocket trailer — extend the JSON trailer format to include `sectionCuts: Array<{ component: string; axis: 'x'|'y'|'z'; position: number }>`.

For the MVP of this feature, derive cut positions client-side as an approximation: at uniform intervals based on `design.sectionOverlap` and bed dimensions, applied to the mesh's bounding box. This avoids requiring backend trailer changes and gives a useful visual even before the optimizer data is available.

```tsx
// In Scene.tsx, import the overlay component:
{showSectionOverlay && meshData && (
  <SectionCutOverlay
    meshOffset={meshOffset}
    wingSpan={design.wingSpan}
    fuselageLength={design.fuselageLength}
    bedX={design.printBedX}
    bedY={design.printBedY}
  />
)}
```

`SectionCutOverlay` renders thin plane meshes (using `<planeGeometry>` with `<meshBasicMaterial>` in amber at low opacity) at each calculated cut station. These planes are translucent (`opacity={0.15}`) and do not cast shadows, acting as visual guides only.

---

## General Frontend Patterns for v0.7

All worker agents implementing any v0.7 issue must follow these patterns. Deviating requires explicit justification.

### Disabled-When-Disconnected Pattern

Every new interactive input control (`ParamSlider`, `ParamToggle`, `ParamSelect`, custom inputs) must receive a `disabled` prop sourced from the connection store. The pattern used throughout the app:

```tsx
// At the top of each panel component:
const isConnected = useConnectionStore((s) => s.state === 'connected');

// On every ParamSlider, ParamToggle, ParamSelect:
<ParamSlider
  ...
  disabled={!isConnected}
/>
```

The `useConnectionStore` import: `import { useConnectionStore } from '../../store/connectionStore';`

This pattern is non-negotiable. Every new input must be disabled when `state !== 'connected'`.

### Tooltip / Title Pattern

Every new parameter must have a `title` prop on its `ParamSlider`, `ParamToggle`, or `ParamSelect`. The `title` prop renders as an HTML tooltip on hover (the `div` wrapper in `ParamSlider` already has `title={title}`). This is the only tooltip mechanism used in this codebase — do not add Radix `Tooltip` wrappers unless a custom tooltip with rich content is needed (the warning tooltip in `ParamSlider` is the only existing exception).

Tooltip text guidelines:
- Describe **what** the parameter controls, not its name
- Include units and typical values: `"Main gear strut height in mm. 40mm gives adequate prop clearance for most wing mounts."`
- For boolean toggles: describe what happens when enabled: `"Enable elevator cutout on the horizontal stabilizer. Generates a separate elevator body for assembly."`
- Maximum ~120 characters

### camelCase / snake_case Convention

- **TypeScript / Store / Frontend:** All new fields are camelCase (`aileronEnable`, `mainGearHeight`)
- **Backend storage / Pydantic:** snake_case (`aileron_enable`, `main_gear_height`)
- **API serialization:** The existing `CamelModel` base class handles camelCase aliasing automatically. New backend fields follow the same pattern — define in snake_case on the Pydantic model, and the alias generator produces camelCase for the frontend.

### Array Parameters in the Store

For array-type parameters (`panelBreaks`, `panelDihedrals`, `panelSweeps`), do **not** use `setParam` — it only handles scalar values. Use dedicated store actions (`setPanelBreak`, etc.) that produce properly typed updates via `produce`.

When comparing arrays for preset detection in `detectPreset`, use `JSON.stringify` comparison for the array fields (since `===` on arrays always returns false):

```typescript
// In PRESET_COMPARE_KEYS, do NOT add array fields (they will never match via ===)
// Instead, in detectPreset, add a separate check for array fields:
const arrayMatch = ['panelBreaks', 'panelDihedrals', 'panelSweeps'].every(
  (k) => JSON.stringify(design[k as keyof AircraftDesign]) === JSON.stringify(ref[k as keyof AircraftDesign])
);
```

### Adding New Files

New panel files go in `frontend/src/components/panels/`. Export the component named function from the file. Register in `ComponentPanel.tsx`.

Do not create an `index.ts` barrel for new files unless one already exists for the directory (there is no `panels/index.ts` currently — import directly by path).

### History / Undo-Redo

New `setParam` calls automatically participate in Zundo undo/redo via the existing `partialize` function (which snapshots `design`). New dedicated store actions (like `setPanelBreak`) must also trigger a Zundo snapshot — ensure they use `set(produce(...))` and not `set((s) => ...)`, since Zundo only wraps the top-level `set` call from `temporal`.

**Verify:** After implementing, check that pressing Ctrl+Z after changing a panel break position reverts it correctly.

### Validation Warning Display

New validation warnings introduced by backend logic for v0.7 parameters should use V-numbers continuing from V28 (the last in v0.6). The `WarningId` type in `types/design.ts` must be extended:

```typescript
export type StructuralWarningId = 'V01' | 'V02' | 'V03' | 'V04' | 'V05' | 'V06' | 'V07' | 'V08';
export type PrintWarningId = 'V16' | 'V17' | 'V18' | 'V20' | 'V21' | 'V22' | 'V23';
export type ControlSurfaceWarningId = 'V29' | 'V30' | 'V31';  // new for v0.7
export type LandingGearWarningId = 'V32' | 'V33';              // new for v0.7
export type WarningId = StructuralWarningId | PrintWarningId | ControlSurfaceWarningId | LandingGearWarningId;
```

Proposed warning IDs for v0.7:
- `V29`: Aileron/flap span overlap
- `V30`: Control surface chord exceeds 50% of wing chord (unusual)
- `V31`: Multi-section wing break positions not monotonically increasing
- `V32`: Landing gear height insufficient for propeller clearance
- `V33`: Main gear too far forward (taildragger CG concern)

These warnings display via the existing `ValidationPanel` and the inline `hasWarning` / `warningText` props on `ParamSlider`. Wire them up to the relevant fields using the `fieldHasWarning` / `getFieldWarnings` helpers from `../../lib/validation`.

### Minimum Viewport Width

All new panels must be readable at 1280px viewport width. The component panel sits in a fixed-width sidebar (approximately 280–320px). Test that:
- `ParamSlider` labels do not overflow at typical parameter name lengths
- Collapsible sub-section headers with long titles wrap gracefully
- The `LandingGearPanel` three-column summary grid in `ExportDialog` renders correctly at narrow dialog widths

### Radix UI Primitives Available

The following Radix primitives are already installed and available for use:
- `@radix-ui/react-dialog` — used in `ExportDialog`
- `@radix-ui/react-alert-dialog` — used in `GlobalPanel`
- `@radix-ui/react-tooltip` — used in `ParamSlider`

For v0.7, avoid adding new Radix dependencies. Use the manual toggle pattern (like `PrintSettingsSection`) for collapsible sections.

---

## File Change Summary

For each issue, the files that require changes:

### Issue #143 (Multi-Section Wings)

| File | Change Type |
|------|-------------|
| `frontend/src/types/design.ts` | Add 4 new fields + extend `ComponentRanges` + extend sub-elements |
| `frontend/src/store/designStore.ts` | Add 3 new actions, extend `setParam` side-effect, extend `PARAM_LABELS` |
| `frontend/src/lib/presets.ts` | Add defaults to all 6 presets + Glider special case |
| `frontend/src/components/panels/WingPanel.tsx` | Add wingSections slider + conditional panel sub-sections |
| `frontend/src/components/Viewport/AircraftMesh.tsx` | Extend `COMPONENT_COLORS`, extend render loop |

### Issue #144 (Control Surfaces)

| File | Change Type |
|------|-------------|
| `frontend/src/types/design.ts` | Add 14 new fields + extend `ComponentRanges` + extend `WarningId` |
| `frontend/src/store/designStore.ts` | Add to `PARAM_LABELS`, `PRESET_COMPARE_KEYS` |
| `frontend/src/lib/presets.ts` | Add defaults to all presets |
| `frontend/src/components/panels/WingPanel.tsx` | Add Ailerons/Elevons collapsible section |
| `frontend/src/components/panels/TailConventionalPanel.tsx` | Add Elevator + Rudder collapsible sections |
| `frontend/src/components/panels/TailVTailPanel.tsx` | Add Ruddervators collapsible section |
| `frontend/src/components/Viewport/AircraftMesh.tsx` | Extend colors, extend render loop for control surface meshes |
| `frontend/src/components/ExportDialog.tsx` | Extend `componentColor`, `componentLabel` helpers |

### Issue #145 (Landing Gear)

| File | Change Type |
|------|-------------|
| `frontend/src/types/design.ts` | Add `LandingGearType`, add 9 new fields, extend `ComponentSelection`, extend `PerComponentPrintSettings` |
| `frontend/src/store/designStore.ts` | Add to `PARAM_LABELS`, `PRESET_COMPARE_KEYS`, extend `setComponentPrintSetting` signature |
| `frontend/src/lib/presets.ts` | Add defaults to all presets |
| `frontend/src/components/panels/LandingGearPanel.tsx` | **New file** |
| `frontend/src/components/panels/ComponentPanel.tsx` | Add landing_gear branch |
| `frontend/src/components/panels/PrintSettingsSection.tsx` | Extend component prop type |
| `frontend/src/components/Viewport/AircraftMesh.tsx` | Extend colors, extend render loop for gear meshes |
| `frontend/src/components/ExportDialog.tsx` | Extend `componentColor`, `componentLabel` helpers |

### Issue #146 (Test Joint)

| File | Change Type |
|------|-------------|
| `frontend/src/components/ExportDialog.tsx` | Add state, handler, UI section, diagram sub-component |

### Issue #147 (Smart Split Optimizer)

| File | Change Type |
|------|-------------|
| `frontend/src/types/design.ts` | Extend `ExportPreviewPart` interface |
| `frontend/src/store/designStore.ts` | Add `showSectionOverlay` + `toggleSectionOverlay` |
| `frontend/src/components/Viewport/Controls.tsx` | Add Sections toggle button |
| `frontend/src/components/Viewport/Scene.tsx` | Add `SectionCutOverlay` rendering |
| `frontend/src/components/ExportDialog.tsx` | Extend part rows, add adjusted cuts warning, add `BedPreviewVisualization` |

---

## Backend API Contracts Expected

Worker agents implementing the frontend must coordinate with backend agents on these API contracts:

### POST /api/export/test-joint

**Request body:**
```json
{
  "jointType": "Tongue-and-Groove",
  "jointTolerance": 0.15,
  "sectionOverlap": 15,
  "nozzleDiameter": 0.4
}
```

**Response:** `application/zip` blob — a ZIP containing `test_joint_male.stl` and `test_joint_female.stl` (the two halves of the test piece). The test piece geometry is two rectangular blocks (50mm × 30mm × 20mm) joined by the configured joint profile.

### WebSocket trailer extension for Section Cuts

Extend the JSON trailer to include:
```json
{
  "componentRanges": { ... },
  "derived": { ... },
  "warnings": [ ... ],
  "sectionCuts": [
    { "component": "wing", "side": "left", "axis": "y", "positionMm": 150.0, "adjusted": false },
    { "component": "fuselage", "axis": "x", "positionMm": 200.0, "adjusted": true, "reason": "Avoided spar channel" }
  ]
}
```

The frontend reads `sectionCuts` from the parsed WebSocket trailer and stores it in the design store for use by `SectionCutOverlay`.

### ExportPreviewPart extension

Backend must populate `cutPositionMm`, `cutAdjusted`, and `cutAdjustReason` on all `ExportPreviewPart` objects where a cut was made.

---

*Document version: v0.7-draft-1. Review with Gemini Pro before worker agents begin implementation.*
